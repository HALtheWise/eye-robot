<html>
<head>
  <link rel="stylesheet" type="text/css" href="styles.css" media="screen" />
  <title>Eye-Robot Control</title>

  <script type="text/javascript">
  'use strict'


    var ws;

    var pan = 0;
    var tilt = 0;
    var drive = 0;
    var turn = 0;
    
    var oldPan = 0;
    var oldTilt = 0;
	  
    function init() {

      // Connect to Web Socket
      ws = new WebSocket("ws://localhost:9001/");
		

      // Set event handlers.
      ws.onopen = function() {
        testVideo();
        output("onopen");
        pan = 0;
        tilt = 0;
        drive = 0;
        turn = 0;
        sendMessage(0,0,0,0);
      };

      ws.onmessage = function(e) {
        // e.data contains received string.
        output("onmessage: " + e.data);
      };

      ws.onclose = function() {
        output("onclose");
      };

      ws.onerror = function(e) {
        output("onerror");
        console.log(e)
      };

    }

    function onSubmit() {
      var input = document.getElementById("input");
      // You can send message to the Web Socket using ws.send.
      ws.send(input.value);
      output("send: " + input.value);
      input.value = "";
      input.focus();
    }

    function onCloseClick() {
      ws.close();
    }
    
    function testVideo() {
      var tester=new Image();
      tester.onerror=videoNotFound;
      tester.src='/video/'
    }
    
    function videoNotFound() {
      alert('The video stream had an error loading. Please contact eric.miller@students.olin.edu to report the issue.');
    }

    var logdata = []
    function output(str) {
      var log = document.getElementById("log");
      var escaped = str.replace(/&/, "&amp;").replace(/</, "&lt;").
        replace(/>/, "&gt;").replace(/"/, "&quot;"); // "
      //log.innerHTML = escaped + "<br>" + log.innerHTML;

      logdata.push(escaped)
      logdata = logdata.slice(-10)
      log.innerText = logdata.join('\n');
    }

    function sendMessage(forward, turn, pan, tilt) {

      if ((oldPan != pan) || (oldTilt != tilt)) {
        
        var message = [forward, turn, pan, tilt].join(',')

        ws.send(message);
        output("sent: " + message);
      }
      
      oldPan = pan;
      oldTilt = tilt;

    }
	  
    function sendCommand() {
      var tiltLimit = 30;
      var panLimit = 80;
      pan = cap(panLimit, pan);
      tilt = cap(tiltLimit, tilt);
      sendMessage(drive, turn, pan, tilt);
    }

    // window.setInterval(sendCommand, .1);

    document.onkeyup = function() {
      drive = turn = 0;
      sendCommand();
    }
	
	function cap(lim, val) {
	  if (Math.abs(parseInt(val)) > lim) {
        val = lim * Math.sign(val);
      }
	  return val;
	}

    document.onkeyup= function(evt) {
        evt = evt || window.event;
        var charCode = evt.keyCode || evt.which;
        var charStr = String.fromCharCode(charCode);

      var importantButtonPressed = 1;
      console.log('pressed', charStr)
        if (charStr == 'W') {
          drive = drivePower;
        } else if (charStr == 'S') {
          drive = -drivePower;
        } else if (charStr == 'A') {
          turn = -drivePower;
        } else if (charStr == 'D') {
          turn = drivePower;
        } else if (charStr == 'I') {
          tilt += increment;
        } else if (charStr == 'K') {
          tilt -= increment;
        } else if (charStr == 'J') {
          pan -= increment;
        } else if (charStr == 'L') {
          pan += increment;
        } else {
          importantButtonPressed = 0;
        }
      
        if(importantButtonPressed) {
          
          sendCommand();
        }
    };


    var increment = 10;

    var drivePower = 1.0;

  </script>
</head>
<body onload="init();">
  <h1>Eye-Robot Control Station</h1>
  <img src="/video/">
  <br> <br>
  <div id = "debugBox">
    <form onsubmit="onSubmit(); return false;">
      <input type="text" id="input">
      <input type="submit" value="Send">
      <button onclick="onCloseClick(); return false;">close</button>
    </form>
    <div id="log"></div>
  </div>
</body>
</html>
